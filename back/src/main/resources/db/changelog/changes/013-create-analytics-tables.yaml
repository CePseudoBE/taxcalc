databaseChangeLog:
  # ===========================================
  # TABLE: search_events
  # Chaque recherche effectuee (anonyme ou connecte)
  # ===========================================
  - changeSet:
      id: 13
      author: axel
      comment: "Table des evenements de recherche"
      changes:
        - createTable:
            tableName: search_events
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: session_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: user_id
                  type: bigint
              - column:
                  name: brand_id
                  type: bigint
              - column:
                  name: model_id
                  type: bigint
              - column:
                  name: variant_id
                  type: bigint
              - column:
                  name: region
                  type: region
              - column:
                  name: fuel_type
                  type: fuel_type
              - column:
                  name: is_new_vehicle
                  type: boolean
              - column:
                  name: first_registration_date
                  type: date
              - column:
                  name: search_type
                  type: search_type
                  constraints:
                    nullable: false
              - column:
                  name: device_type
                  type: device_type
              - column:
                  name: referrer_source
                  type: varchar(100)
              - column:
                  name: user_agent_hash
                  type: varchar(64)
              - column:
                  name: language
                  type: varchar(10)
              - column:
                  name: created_at
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
        - addForeignKeyConstraint:
            baseTableName: search_events
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            constraintName: fk_search_events_user
        - addForeignKeyConstraint:
            baseTableName: search_events
            baseColumnNames: brand_id
            referencedTableName: brands
            referencedColumnNames: id
            constraintName: fk_search_events_brand
        - addForeignKeyConstraint:
            baseTableName: search_events
            baseColumnNames: model_id
            referencedTableName: models
            referencedColumnNames: id
            constraintName: fk_search_events_model
        - addForeignKeyConstraint:
            baseTableName: search_events
            baseColumnNames: variant_id
            referencedTableName: variants
            referencedColumnNames: id
            constraintName: fk_search_events_variant
        - createIndex:
            tableName: search_events
            indexName: idx_search_events_created
            columns:
              - column:
                  name: created_at
        - createIndex:
            tableName: search_events
            indexName: idx_search_events_session
            columns:
              - column:
                  name: session_id
        - createIndex:
            tableName: search_events
            indexName: idx_search_events_brand
            columns:
              - column:
                  name: brand_id
              - column:
                  name: created_at
        - createIndex:
            tableName: search_events
            indexName: idx_search_events_variant
            columns:
              - column:
                  name: variant_id
              - column:
                  name: created_at
        - createIndex:
            tableName: search_events
            indexName: idx_search_events_filters
            columns:
              - column:
                  name: region
              - column:
                  name: fuel_type
              - column:
                  name: is_new_vehicle

  # ===========================================
  # TABLE: tax_calculations
  # Resultats des calculs de taxe
  # ===========================================
  - changeSet:
      id: 14
      author: axel
      comment: "Table des calculs de taxe"
      changes:
        - createTable:
            tableName: tax_calculations
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: search_event_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: variant_id
                  type: bigint
              - column:
                  name: submission_id
                  type: bigint
              - column:
                  name: region
                  type: region
                  constraints:
                    nullable: false
              - column:
                  name: tax_type
                  type: tax_type
                  constraints:
                    nullable: false
              - column:
                  name: calculated_amount
                  type: decimal(12,2)
                  constraints:
                    nullable: false
              - column:
                  name: power_kw
                  type: integer
              - column:
                  name: cv_fiscal
                  type: integer
              - column:
                  name: co2_gkm
                  type: integer
              - column:
                  name: vehicle_age_months
                  type: integer
              - column:
                  name: is_exempt
                  type: boolean
                  defaultValueBoolean: false
              - column:
                  name: created_at
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
        - addForeignKeyConstraint:
            baseTableName: tax_calculations
            baseColumnNames: search_event_id
            referencedTableName: search_events
            referencedColumnNames: id
            constraintName: fk_tax_calculations_search_event
        - addForeignKeyConstraint:
            baseTableName: tax_calculations
            baseColumnNames: variant_id
            referencedTableName: variants
            referencedColumnNames: id
            constraintName: fk_tax_calculations_variant
        - addForeignKeyConstraint:
            baseTableName: tax_calculations
            baseColumnNames: submission_id
            referencedTableName: vehicle_submissions
            referencedColumnNames: id
            constraintName: fk_tax_calculations_submission
        - createIndex:
            tableName: tax_calculations
            indexName: idx_tax_calculations_variant
            columns:
              - column:
                  name: variant_id
              - column:
                  name: created_at
        - createIndex:
            tableName: tax_calculations
            indexName: idx_tax_calculations_amount
            columns:
              - column:
                  name: calculated_amount
                  descending: true

  # ===========================================
  # TABLE: daily_aggregates
  # Agregats quotidiens pre-calcules
  # ===========================================
  - changeSet:
      id: 15
      author: axel
      comment: "Table des agregats quotidiens"
      changes:
        - createTable:
            tableName: daily_aggregates
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: date
                  type: date
                  constraints:
                    nullable: false
              - column:
                  name: region
                  type: region
              - column:
                  name: brand_id
                  type: bigint
              - column:
                  name: model_id
                  type: bigint
              - column:
                  name: fuel_type
                  type: fuel_type
              - column:
                  name: is_new_vehicle
                  type: boolean
              - column:
                  name: search_count
                  type: integer
                  defaultValueNumeric: 0
              - column:
                  name: calculation_count
                  type: integer
                  defaultValueNumeric: 0
              - column:
                  name: unique_sessions
                  type: integer
                  defaultValueNumeric: 0
              - column:
                  name: avg_tax_amount
                  type: decimal(12,2)
              - column:
                  name: max_tax_amount
                  type: decimal(12,2)
              - column:
                  name: min_tax_amount
                  type: decimal(12,2)
        - addForeignKeyConstraint:
            baseTableName: daily_aggregates
            baseColumnNames: brand_id
            referencedTableName: brands
            referencedColumnNames: id
            constraintName: fk_daily_aggregates_brand
        - addForeignKeyConstraint:
            baseTableName: daily_aggregates
            baseColumnNames: model_id
            referencedTableName: models
            referencedColumnNames: id
            constraintName: fk_daily_aggregates_model
        - createIndex:
            tableName: daily_aggregates
            indexName: idx_daily_aggregates_date
            columns:
              - column:
                  name: date
              - column:
                  name: region

  # ===========================================
  # TABLE: popular_vehicles
  # Snapshot hebdomadaire des vehicules populaires
  # ===========================================
  - changeSet:
      id: 16
      author: axel
      comment: "Table des vehicules populaires"
      changes:
        - createTable:
            tableName: popular_vehicles
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: week_start
                  type: date
                  constraints:
                    nullable: false
              - column:
                  name: region
                  type: region
                  constraints:
                    nullable: false
              - column:
                  name: ranking_type
                  type: ranking_type
                  constraints:
                    nullable: false
              - column:
                  name: rank
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: variant_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: brand_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: model_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: search_count
                  type: integer
                  defaultValueNumeric: 0
              - column:
                  name: avg_tax_tmc
                  type: decimal(12,2)
              - column:
                  name: avg_tax_annual
                  type: decimal(12,2)
              - column:
                  name: created_at
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
        - addForeignKeyConstraint:
            baseTableName: popular_vehicles
            baseColumnNames: variant_id
            referencedTableName: variants
            referencedColumnNames: id
            constraintName: fk_popular_vehicles_variant
        - addForeignKeyConstraint:
            baseTableName: popular_vehicles
            baseColumnNames: brand_id
            referencedTableName: brands
            referencedColumnNames: id
            constraintName: fk_popular_vehicles_brand
        - addForeignKeyConstraint:
            baseTableName: popular_vehicles
            baseColumnNames: model_id
            referencedTableName: models
            referencedColumnNames: id
            constraintName: fk_popular_vehicles_model
        - createIndex:
            tableName: popular_vehicles
            indexName: idx_popular_vehicles_week
            columns:
              - column:
                  name: week_start
              - column:
                  name: region
              - column:
                  name: ranking_type
        - addUniqueConstraint:
            tableName: popular_vehicles
            columnNames: week_start, region, ranking_type, rank
            constraintName: uk_popular_vehicles_ranking

  # ===========================================
  # TABLE: analytics_reports
  # Rapports generes (archives avant purge)
  # ===========================================
  - changeSet:
      id: 17
      author: axel
      comment: "Table des rapports analytics"
      changes:
        - createTable:
            tableName: analytics_reports
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: report_type
                  type: report_type
                  constraints:
                    nullable: false
              - column:
                  name: title
                  type: varchar(200)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: text
              - column:
                  name: period_start
                  type: date
                  constraints:
                    nullable: false
              - column:
                  name: period_end
                  type: date
                  constraints:
                    nullable: false
              - column:
                  name: region
                  type: region
              - column:
                  name: report_data
                  type: jsonb
                  constraints:
                    nullable: false
              - column:
                  name: metadata
                  type: jsonb
              - column:
                  name: is_public
                  type: boolean
                  defaultValueBoolean: false
              - column:
                  name: created_at
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
        - createIndex:
            tableName: analytics_reports
            indexName: idx_analytics_reports_type
            columns:
              - column:
                  name: report_type
              - column:
                  name: period_start
        - createIndex:
            tableName: analytics_reports
            indexName: idx_analytics_reports_period
            columns:
              - column:
                  name: period_start
              - column:
                  name: period_end
